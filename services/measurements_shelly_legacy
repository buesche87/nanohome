#!/bin/bash
#/////////////////////////////////////////////////////////////////////////////////////
# Nanohome Shelly Legacy measurement watcher
#
# Subscribe to the status topic of all devices
# Check the connected status of each COMPONENT not filtered in config
# For each connected COMPONENT parse the status json and write values to influxdb
#/////////////////////////////////////////////////////////////////////////////////////

# Read measurements
read_measurement() {
	while read -r line; do
		influx write -b "${INFLUXDB_BUCKET_MEASUREMENTS}" -p s "$2 $1=$line"
	done < <(mosquitto_sub -h "${MQTT_SERVICE}" -u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "$3" -q 2) &
}

# Main Service
while /bin/true; do
	
	# Get all connected devices
	CONNECTEDTOPIC="shellies/+/+/+/connected"
	CONNECTEDDEVICES=($(mosquitto_sub -h "${MQTT_SERVICE}" -u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${CONNECTEDTOPIC}" -W 2 --retained-only --nodelay --quiet -F "%t,%p"))

	# Process every device available
	for CONNECTEDDEVICE in "${CONNECTEDDEVICES[@]}"; do

		# Extract message from online topic
		DEVICETOPIC=$(echo "${CONNECTEDDEVICE}" | cut -d ',' -f 1)
		DEVICEMESSAGE=$(echo "${CONNECTEDDEVICE}" | cut -d ',' -f 2-)
		DEVICEID=$(echo "${DEVICETOPIC}" | cut -d '/' -f 2)
		COMPONENT=$(echo "${DEVICETOPIC}" | cut -d '/' -f 3)
		COMPONENTINDEX=$(echo "${DEVICETOPIC}" | cut -d '/' -f 4)	
		
		# Get description
		DESCRIPTIONTOPIC="shellies/${DEVICEID}/${COMPONENT}/${COMPONENTINDEX}/description"
		DESCRIPTIONMESSAGE=$(mosquitto_sub -h "${MQTT_SERVICE}" -u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${DESCRIPTIONTOPIC}" -C 1 -W 1 --retained-only --nodelay --quiet)
		DESCRIPTION="${DESCRIPTIONMESSAGE// /\\ }"
		
		# Check for measurement topic
		ENERGYTOPIC="shellies/${DEVICEID}/${COMPONENT}/${COMPONENTINDEX}/energy"
		POWERTOPIC="shellies/${DEVICEID}/${COMPONENT}/${COMPONENTINDEX}/power"
		TEMPERATURETOPIC="shellies/${DEVICEID}/${COMPONENT}/${COMPONENTINDEX}/temperature"
		
		# Read measurements
		[ -n "${DESCRIPTION}" ] && read_measurement "Energy" "${DESCRIPTION}" "${ENERGYTOPIC}"
		[ -n "${DESCRIPTION}" ] && read_measurement "Power" "${DESCRIPTION}" "${POWERTOPIC}"
		[ -n "${DESCRIPTION}" ] && read_measurement "Energy" "${DESCRIPTION}" "${TEMPERATURETOPIC}"
		
	done
	
	tail -f /dev/null

done
