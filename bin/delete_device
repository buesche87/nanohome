#!/bin/bash
#/////////////////////////////////////////////////////////////////////////////////////
# Nanohome remove a device from InfluxDB
#/////////////////////////////////////////////////////////////////////////////////////

DEVICE="$1"
COMPONENT="$2"
DESCRIPTION="$3"
LEGACY="$4"

# Delete Measurement
if [ -n $DEVICE ]; then
	influx delete --bucket "${INFLUXDB_BUCKET_DEVICES}" \
	  --start '1970-01-01T00:00:00Z' \
	  --stop $(date --utc +"%Y-%m-%dT%H:%M:%SZ") \
	  --predicate '_measurement="'"${DEVICE}"'"'
fi

# Nanohome topics
DEVICETOPIC="nanohome/${DESCRIPTION}/device"
TIMERTOPIC="nanohome/${DESCRIPTION}/timer"
STANDBYTOPIC="nanohome/${DESCRIPTION}/standby"

# Device topics
if [ "${LEGACY}" == "true" ]; then
	COMPONENTNAME=$(echo "${COMPONENT}" | cut -d ':' -f 1)
	COMPONENTINDEX=$(echo "${COMPONENT}" | cut -d ':' -f 2)

	CONNECTEDTOPIC="shellies/${DEVICE}/${COMPONENTNAME}/${COMPONENTINDEX}/connected"
	DESCRIPTIONTOPIC="shellies/${DEVICE}/${COMPONENTNAME}/${COMPONENTINDEX}/description"
	OUTPUTTOPIC="shellies/${DEVICE}/${COMPONENTNAME}/${COMPONENTINDEX}/output"
else
	ONLINETOPIC="${DEVICE}/online"
	CONNECTEDTOPIC="${DEVICE}/status/${COMPONENT}/connected"
	DESCRIPTIONTOPIC="${DEVICE}/status/${COMPONENT}/description"
	OUTPUTTOPIC="${DEVICE}/status/${COMPONENT}/output"	
	
	mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${ONLINETOPIC}" -m ""
fi

# Clean topics
mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${DEVICETOPIC}" -m ""
mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${TIMERTOPIC}" -m ""
mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${STANDBYTOPIC}" -m ""
mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${CONNECTEDTOPIC}" -m ""
mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${DESCRIPTIONTOPIC}" -m ""
mosquitto_pub -r -h "${MQTT_SERVER}"-u "${MQTT_USER}" -P "${MQTT_PASSWORD}" -t "${OUTPUTTOPIC}" -m ""

# Remove from crontab
sed -i "/${DEVICE}/d" /etc/crontab
