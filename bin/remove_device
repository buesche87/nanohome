#!/bin/bash
#/////////////////////////////////////////////////////////////////////////////////////
# nanohome - remove_device
#
# Remove a device from nanohome
# - Clear its measurements from influxdb
# - Delete its retained mqtt messages
# - Remove crontab entries
#/////////////////////////////////////////////////////////////////////////////////////
DEVICE="$1"

# MQTT connection string with credentials
MQTT_CONNECTION_STRING=(-h "$MQTT_SERVER" -u "$MQTT_USER" -P "$MQTT_PASSWORD")

# Delete device from influxdb
if [[ -n $DEVICE ]]; then
	$curl_status=$(curl --request POST "${INFLUXDB_HOST}/api/v2/delete?org=${INFLUXDB_ORG}&bucket=${INFLUXDB_BUCKET_DEVICES}" \
	--header "Authorization: Token ${INFLUXDB_TOKEN}" \
	--header "Content-Type: application/json" \
	--data '{
		"start": "1970-01-01T00:00:00Z",
		"stop": "'"$(date --utc +"%Y-%m-%dT%H:%M:%SZ")"'",
		"predicate": "_measurement=\"'"${DEVICE}"'\""
	}')

	# Check if this was successfull
	if [ "$curl_status" -eq 200 ] || [ "$curl_status" -eq 202 ]; then
		echo -e "${LOG_SUCC} Remove device: Device \"${DEVICE}\" removed" >> /proc/1/fd/1
	else
		echo -e "${LOG_ERRO} Remove device: Failed to remove device \"${DEVICE}\"" >> /proc/1/fd/1
		echo -e "${LOG_ERRO}  > status code: $curl_status" >> /proc/1/fd/1
	fi
fi
